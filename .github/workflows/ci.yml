name:                     CI
on:                       [push, pull_request]

jobs:
  build:
    strategy:
      matrix:
        name:             [mac, ubuntu-mpich, ubuntu-standard, ubuntu-debug,
                           ubuntu-nogather, ubuntu-conda]
        include:
          - name:         ubuntu-standard
            os:           ubuntu-latest
            testos:       LINUX
            maketest:     "ctest"
            testexamples: 1
            debug:        0
            noalligather: 0
            mpich:        0
            conda:        0
          - name:         ubuntu-debug
            os:           ubuntu-latest
            testos:       LINUX
            maketest:     "ctest -R Regression111"
            testexamples: 1
            debug:        1
            noalligather: 0
            mpich:        0
            conda:        0
          - name:         ubuntu-nogather
            os:           ubuntu-latest
            testos:       LINUX
            maketest:     "ctest"
            testexamples: 1
            debug:        0
            noalligather: 1
            mpich:        0
            conda:        0
          - name:         ubuntu-mpich
            os:           ubuntu-latest
            testos:       LINUX
            maketest:     "ctest -R Regression211"
            testexamples: 0
            debug:        0
            noalligather: 0
            mpich:        1
            conda:        0
          - name:         mac
            os:           macos-latest
            testos:       OSX
            maketest:     "ctest -R Regression111"
            testexamples: 0
            debug:        0
            noalligather: 0
            mpich:        0
            lint:         1
            conda:        0
          - name:         ubuntu-conda
            os:           ubuntu-latest
            testos:       LINUX
            maketest:     "ctest -R Regression111"
            testexamples: 0
            debug:        0
            noalligather: 0
            mpich:        0
            conda:        1
    runs-on:              ${{ matrix.os }}
    steps:
    - uses:               actions/checkout@v1
    - uses:               conda-incubator/setup-miniconda@v2
      with:
        auto-activate-base: true
        activate-environment: ""
    - name:               setup environment
      run:                bash UnitTests/before_install.sh
      env:
        TESTOS:           ${{ matrix.testos }}
        MPICH:            ${{ matrix.mpich }}
        CONDA:            ${{ matrix.conda }}
    - name:               build ntpoly
      run:                |
        bash UnitTests/run_cmake.sh
      env:
        TESTOS:           ${{ matrix.testos }}
        DEBUG:            ${{ matrix.debug }}
        NOALLIGATHER:     ${{ matrix.noalligather }}
        CONDA:            ${{ matrix.conda }}
    - name:               regression tests
      run:                |
        bash UnitTests/run_ci_test.sh
      env:
        MAKETEST:         ${{ matrix.maketest }}
        CONDA:            ${{ matrix.conda }}
    - name:               check examples
      run:                |
        cd UnitTests
        bash check_examples.sh
        cd ../
      env:
        TESTEXAMPLES:     ${{ matrix.testexamples }}
    - name:               lint
      if:                 ${{ matrix.lint }}
      run:                |
        bash UnitTests/lint.sh
    - name: upload artifacts
      if: always()
      uses: actions/upload-artifact@v1
      with:
        name: build
        path: Build
